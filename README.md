
Cometa
======

Scans your music directory. Creates audio fingerprints. Looking for duplicated audio.



Setup
-----

Install [Python](https://www.python.org/downloads/), [fpcalc](https://acoustid.org/chromaprint) and [ffmpeg](https://ffmpeg.org/download.html). It is necessary you can call them on the command line by name. [Help for Windows.](https://phoenixnap.com/kb/ffmpeg-windows)

Then download the archive with the project, unpack it into a directory, and type in command line:

    cd parent/path/cometa
    pip install -r requirements.txt


Usage
-----

Type in command line:

    python parent/path/cometa/cometa/cometa.py


How it works
------------

ffmpeg превращает закодированные по-разному файлы в единый простой формат, который способен прочесть fpcalc. fpcalc строит спектрограмму файла, а затем упрощает её до 32 точек по высоте, и 8 точек на 1 секунду по длине. Каждая точка либо заполнена (считаем, что на этой частоте в этот момент времени звук был), либо пуста (считаем, что звука не было). Эта упрощённая карта (двухмерный массив бит) - "отпечаток" (fingerprint).

Cometa получает от fpcalc отпечаток, и сохраняет. Затем сравнивает - похожи ли карты разных треков. Если у обоих отпечатков в соответствующих точках (на нужной секунде и частоте) звук пристутсвует или отстутствует - это 1 балл за то, что треки похожи. Если же в соотвествующих точках в одном отпечатке есть звук, а в другом нету, то это 1 балл за то, что треки различаются. Общее количество баллов - это количество точек, которые мы сравнили, то есь, по сути - это размер отпечатка более короткого трека (или размер того "окна", которое мы выбрали из отпечатков, чтобы сравнивать).

Величина корреляции - это доля совпавших точек из общего числа точек, которые Комета сравнила. Чем больше корреляция отпечатков - тем более похожи сами треки. В среднем корреляция 0.5 - такая будет у большинства треков, и у двух абсолютно случайных шумов. По опыту, 1% самых похожих пар треков имеют корреляцию выше 0.577. Треки с корреляцией выше 0.9 чаще всего являются одной и той же песней, закодированной разными способами, или "клонами", содержащими одинаковую музыку, но опубликованные под разными названиями.



Заметки
-------

### fpcalc

У отпечатка длина семпла 0.125 сек при частоте семплирования аудио 44100. Результат других частот я не анализировал. Размер семпла всегда 32 бита. Если семпл содержит только `0` (в виде числа - семпл равен 0), то в фингерпринт он не попадает - я искал такие, и пока не обнаружил.

Какие выводы из этого? Треки сперва надо сканировать на наличие тишины в середине. Такое часто делалось во времена CD - последний трек содержал не только музыку, но N минут тишины следом, и после неё - один или несколько "скрытых" треков, разделённых тишиной. При копировании такой дорожки в файл - получается трек с долгими отрезками тишины в середине.

Моя позиция - нужно разрезать такие треки на отдельные. Скажем, если длина тишины более 5 секунд. Конкретная величина требует анализа. Это будет возможно, когда в Комете появится функция поиска тишины и функция разделения треков по ней без переконвертации.

Если не указывать длину сканирования (в секундах) - `fpcalc` вернёт 948 семплов, это 118.5 секунд. Полагаю, планировалось семплить по-умолчанию 2 минуты, однако либо большинство треков содержат 1.5 секунды тишины, либо алгоритм действует чуть иначе чем задумано.

Поэтому длина, на которую Комета заказывает фингерпринт - прямо указана как 1.5 часа. Это чуть больше чем длина полного CD. У меня в коллекции самый длинный отдельный трек - 1 час 12 минут. Всё что длинее - это сборники треков, которых я храню отдельно, и не сканирую. Поскольку коллекция и фингерпринты - это конкретно для отдельных треков.



Inspired by
-----------

### fingerprint

- <https://shivama205.medium.com/audio-signals-comparison-23e431ed2207>
- <https://github.com/kdave/audio-compare>
